# Weapply PM - AI Refinement Project Rules

## Project Context
This is the **Weapply PM** project - an AI-powered email-to-Linear ticket refinement system.
- **Linear Project**: WeApply - AI Refinement
- **Team**: WeTest
- **Repository**: weapply-pm

## Key Files
- `src/index.ts` - Express server, webhook endpoint
- `src/linearWebhookHandler.ts` - Webhook processing logic
- `src/contentRefiner.ts` - OpenAI prompt and refinement
- `src/linearApiClient.ts` - Linear GraphQL API client
- `src/emailParser.ts` - Email parsing utilities
- `src/config.ts` - Environment configuration
- `REFINEMENT_PLAN.md` - Documentation and roadmap

## Linear Integration Rules

### When Making Changes
1. **Always create/update Linear issues** for significant work
2. **Use project**: "WeApply - AI Refinement"
3. **Assign to**: pelle@weapply.se (unless otherwise specified)
4. **Use labels**: Feature, Bug, Improvement, Task + relevant tech labels

### Issue Tracking
- WET-17: Auto-assign from internal senders
- WET-18: Client project auto-creation
- WET-19: Enhanced urgency detection
- WET-20: Attachment capture and analysis
- WET-21: Internal forward detection
- WET-22: External direct email routing
- WET-23: Manual ticket refinement
- WET-24: Improve AI prompt

## Development Guidelines

### Code Style
- TypeScript with strict mode
- ES modules (type: "module")
- Async/await for all async operations
- Descriptive console.log with emojis for visibility

### Testing
- Test webhook with: `curl -X POST http://localhost:3002/webhook/linear-webhook`
- Check logs: `sudo journalctl -u weapply-pm -f`
- Restart: `npm run build && sudo systemctl restart weapply-pm`

### Label Structure
Labels are organized in groups - pick ONE from each relevant group:
- **Type**: Bug, Feature, Task, Support, Hotfix, etc.
- **Dept**: Development, Design, PM, Accounting, Sales
- **Client**: New Lead, Active Client, Prospect, Internal
- **Tech**: Frontend, Backend, Mobile, Database, Infrastructure
- **Phase**: Discovery, Planning, In Development, Testing, Deployment
- **Billing**: Quote, Invoice, Payment, Contract, Overdue
- **Source**: Email, Internal Forward, External Direct, Forwarded

### Priority Rules
- **1 (Urgent)**: Production down, security, overdue payments, explicit "urgent"
- **2 (High)**: Customer impact, deadlines, sales opportunities
- **3 (Normal)**: Standard work (default)
- **4 (Low)**: Nice to have

## Email Processing Logic

### Sender Detection
```typescript
// Internal sender: @weapply.se
if (senderDomain === 'weapply.se') {
  assignToSender();
  addLabel('Internal');
}

// External sender
if (senderDomain !== 'weapply.se') {
  createOrGetClientProject(senderDomain);
  addLabel('External Direct' | 'Forwarded');
}
```

### Forward Detection
```typescript
// Check for forward patterns
const isForwarded = /^(Fwd?|FW):/i.test(subject);
const forwarderDomain = extractDomain(forwarderEmail);

if (isForwarded && forwarderDomain === 'weapply.se') {
  addLabel('Internal Forward');
  setReporter(forwarder);
}
```

## Remember
- All conversations about this project should create Linear issues
- Update REFINEMENT_PLAN.md when adding features
- Test with real emails before deploying
- Keep the prompt in contentRefiner.ts up to date with label changes
